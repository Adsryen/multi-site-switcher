# 数据库结构说明（Go + SQLite）

状态：已实现（sites/accounts/active_accounts）；建议规划（site_field_schemas）。统一采用“基础字段 + JSON 扩展 props（列名 extra）”以适配异构账号字段。

## 设计总览
- 基础字段：site_key、username、password（可空）。
- 扩展字段：props 映射到表列 extra(JSON)。按站点动态扩展（token/key/quota/expiresAt 等）。
- 外键/级联：删除站点自动级联删除账号与活跃映射。

## 数据表

### sites（已实现）
- key TEXT PK
- name TEXT NOT NULL
- login_url TEXT
- created_at INTEGER
- updated_at INTEGER

用途：站点元数据。后续可扩展 schema 或在下方规范表维护。

### accounts（已实现）
- id TEXT PK
- site_key TEXT NOT NULL → FK sites(key) ON DELETE CASCADE
- username TEXT
- password TEXT
- extra TEXT（JSON，作为 props）
- created_at INTEGER
- updated_at INTEGER

索引：`CREATE INDEX IF NOT EXISTS idx_accounts_site_key_username ON accounts(site_key, username);`

### active_accounts（已实现）
- site_key TEXT PK → FK sites(key) ON DELETE CASCADE
- account_id TEXT NULL → FK accounts(id) ON DELETE SET NULL
- updated_at INTEGER

用途：每站点“当前活跃账号”。

### site_field_schemas（建议规划）
- site_key TEXT
- field TEXT
- type TEXT（string|number|boolean|datetime|json）
- required INTEGER(0/1)
- default TEXT（JSON 序列化）
- regex TEXT
- choices TEXT（JSON 数组）
- secret INTEGER(0/1)
- order INTEGER
- ui_hint TEXT

用途：站点维度的字段定义，用于 UI 渲染与服务端校验 props。可后续通过迁移引入。

## API 映射（约定）
- accounts.extra ←→ API 的 props（map）。
- 返回时：将 extra 反序列化为 props；必要时对 secret 字段做脱敏。
- 写入时：从 props 序列化为 extra。

## 查询与索引建议
- 常用 JSON 路径建议表达式索引（SQLite）：
```sql
-- 按过期时间检索
CREATE INDEX IF NOT EXISTS idx_accounts_expires_at
ON accounts((json_extract(extra, '$.expiresAt')));

-- 按 token 检索
CREATE INDEX IF NOT EXISTS idx_accounts_token
ON accounts((json_extract(extra, '$.token')));
```
- 示例查询：
```sql
-- 某站点全部账号（含基础字段）
SELECT id, site_key, username, password, extra FROM accounts WHERE site_key = 'example';

-- 即将过期（7 天内）
SELECT id FROM accounts
WHERE site_key='example'
  AND datetime(json_extract(extra,'$.expiresAt')) <= datetime('now','+7 days');

-- 通过 token 精确查找
SELECT id FROM accounts
WHERE json_extract(extra,'$.token') = 'abc123';
```

## 迁移与演进
- 新增站点字段：仅更新 site_field_schemas（或 sites.schema）与 UI/校验逻辑，无需改表结构。
- 新增检索维度：增加相应表达式索引。
- 数据一致：启用 `PRAGMA foreign_keys=ON`；写操作更新 updated_at。

## 校验与安全（建议）
- 服务端按 site_field_schemas 校验 props（类型/必填/正则/枚举）。
- secret 字段 API 返回时默认脱敏；日志禁止输出敏感值。
- 时间统一使用 RFC3339 字符串（例如 props.expiresAt）。

## 诊断指引
- 校验 JSON：`SELECT json_valid(extra) FROM accounts WHERE id=?;`
- 查看 props 某字段：`SELECT json_extract(extra, '$.token') FROM accounts WHERE id=?;`
- 检查外键：`PRAGMA foreign_keys;` 应为 1。

## 后续规划（可选）
- 在 `sites` 增加 `schema` JSON 列，替代独立表。
- 为敏感字段引入加密（列级或整体 extra 加密）。
