# 数据库结构说明（Go + SQLite）

状态：已实现（sites/accounts/active_accounts）；建议规划（site_field_schemas）。统一采用“基础字段 + JSON 扩展 props（列名 extra）”以适配异构账号字段。

## 设计总览
- 基础字段：site_key、username、password（可空）。
- 扩展字段：props 映射到表列 extra(JSON)。按站点动态扩展（token/key/quota/expiresAt 等）。
- 外键/级联：删除站点自动级联删除账号与活跃映射。

## 数据表

### sites（已实现）
- key TEXT PK
- name TEXT NOT NULL
- login_url TEXT
- created_at INTEGER
- updated_at INTEGER

用途：站点元数据。后续可扩展 schema 或在下方规范表维护。

### accounts（已实现）
- id TEXT PK
- site_key TEXT NOT NULL → FK sites(key) ON DELETE CASCADE
- username TEXT
- password TEXT
- extra TEXT（JSON，作为 props）
- created_at INTEGER
- updated_at INTEGER

索引：`CREATE INDEX IF NOT EXISTS idx_accounts_site_key_username ON accounts(site_key, username);`

### active_accounts（已实现）
- site_key TEXT PK → FK sites(key) ON DELETE CASCADE
- account_id TEXT NULL → FK accounts(id) ON DELETE SET NULL
- updated_at INTEGER

用途：每站点“当前活跃账号”。

### site_field_schemas（建议规划）
- site_key TEXT
- field TEXT
- type TEXT（string|number|boolean|datetime|json）
- required INTEGER(0/1)
- default TEXT（JSON 序列化）
- regex TEXT
- choices TEXT（JSON 数组）
- secret INTEGER(0/1)
- order INTEGER
- ui_hint TEXT

用途：站点维度的字段定义，用于 UI 渲染与服务端校验 props。可后续通过迁移引入。

## API 映射（约定）
- accounts.extra ←→ API 的 props（map）。
- 返回时：将 extra 反序列化为 props；必要时对 secret 字段做脱敏。
- 写入时：从 props 序列化为 extra。

## 查询与索引建议
- 常用 JSON 路径建议表达式索引（SQLite）：
```sql
-- 按过期时间检索
CREATE INDEX IF NOT EXISTS idx_accounts_expires_at
ON accounts((json_extract(extra, '$.expiresAt')));

-- 按 token 检索
CREATE INDEX IF NOT EXISTS idx_accounts_token
ON accounts((json_extract(extra, '$.token')));
```
- 示例查询：
```sql
-- 某站点全部账号（含基础字段）
SELECT id, site_key, username, password, extra FROM accounts WHERE site_key = 'example';

-- 即将过期（7 天内）
SELECT id FROM accounts
WHERE site_key='example'
  AND datetime(json_extract(extra,'$.expiresAt')) <= datetime('now','+7 days');

-- 通过 token 精确查找
SELECT id FROM accounts
WHERE json_extract(extra,'$.token') = 'abc123';
```

## 迁移与演进
- 新增站点字段：仅更新 site_field_schemas（或 sites.schema）与 UI/校验逻辑，无需改表结构。
- 新增检索维度：增加相应表达式索引。
- 数据一致：启用 `PRAGMA foreign_keys=ON`；写操作更新 updated_at。

## 校验与安全（建议）
- 服务端按 site_field_schemas 校验 props（类型/必填/正则/枚举）。
- secret 字段 API 返回时默认脱敏；日志禁止输出敏感值。
- 时间统一使用 RFC3339 字符串（例如 props.expiresAt）。

## 诊断指引
- 校验 JSON：`SELECT json_valid(extra) FROM accounts WHERE id=?;`
- 查看 props 某字段：`SELECT json_extract(extra, '$.token') FROM accounts WHERE id=?;`
- 检查外键：`PRAGMA foreign_keys;` 应为 1。

## 后续规划（可选）
- 在 `sites` 增加 `schema` JSON 列，替代独立表。
- 为敏感字段引入加密（列级或整体 extra 加密）。

## 迁移策略与运维建议

- **[启动行为]**
  - 服务启动前检查数据库文件是否存在（`MSS_DB_PATH`）。
    - 不存在：强制初始化（执行全部迁移），确保首次可用。
    - 存在：默认跳过迁移，不触表结构；仅输出“待迁移版本”（便于人工决策）。
  - 仅当显式设置 `MSS_AUTO_MIGRATE=1` 且数据库已存在时，才会执行迁移。
  - 迁移在单事务内按文件名顺序执行（`server/internal/migrate/sql/*.sql`），失败自动回滚。
  - 已应用版本记录于 `schema_migrations(version, applied_at)` 账本，仅执行未记录的版本。

- **[环境变量]**
  - `MSS_DB_PATH`：SQLite 文件路径（默认 `./data/mss.db` 或容器内 `/data/mss.db`）。
  - `MSS_LISTEN_ADDR`：监听地址（默认 `:8080`）。
  - `MSS_AUTO_MIGRATE`：是否对“已存在的数据库”执行迁移（默认 `0`，设置为 `1` 才会迁移）。

- **[生产环境建议]**
  - 默认关闭自动迁移（`MSS_AUTO_MIGRATE=0`）。
  - 首次上线（空卷/无 DB 文件）会自动初始化，无需设置环境变量。
  - 结构升级时：先观察日志中的“pending versions”，确认后再短暂开启 `MSS_AUTO_MIGRATE=1` 执行迁移，迁移完成后恢复为 `0`。
  - 多副本部署（K8s/Compose）：仅一个实例或一个 Job 执行迁移，其他副本保持 `MSS_AUTO_MIGRATE=0`，避免并发迁移。

- **[开发环境建议]**
  - 首次或需初始化：`.\n+    start.ps1 -Mode local -AutoMigrate`
  - 日常迭代：`.
    start.ps1 -Mode local`（默认不迁移）

- **[手动迁移流程（生产升级）]**
  1. 正常启动服务（`MSS_AUTO_MIGRATE=0`），观察日志：
     - `existing database found; skipping migrations (MSS_AUTO_MIGRATE=0)...`
     - 如有待迁移：`migrate: pending versions: 0002,...`
  2. 暂停流量或评估低峰时段，备份 DB 文件（卷内 `mss.db`）。
  3. 临时设置 `MSS_AUTO_MIGRATE=1` 并重启一次，观察迁移成功日志；完成后恢复为 `0`。

- **[故障与回滚]**
  - 迁移失败将中断启动并回滚数据库变更；根据日志定位失败 SQL 与版本号。
  - 可从备份恢复 DB 文件；或修复迁移脚本后再次执行。
  - 账本确保已成功的版本不会重复执行。

- **[Docker Compose 示例]**
```yaml
services:
  mss:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: mss-server:dev
    ports:
      - "8080:8080"
    volumes:
      - ./data:/data
    environment:
      - MSS_LISTEN_ADDR=:8080
      - MSS_DB_PATH=/data/mss.db
      - MSS_AUTO_MIGRATE=0   # 生产默认关闭
    # 首次上线若卷中无 /data/mss.db，会自动初始化（无需改此配置）

    # 升级时临时打开迁移方式（完成后改回 0）：
    # environment:
    #   - MSS_AUTO_MIGRATE=1
```

- **[PowerShell（本地）示例]**
```powershell
# 首次/需要初始化
powershell -ExecutionPolicy Bypass -File .\start.ps1 -Mode local -AutoMigrate

# 日常启动（不迁移）
powershell -ExecutionPolicy Bypass -File .\start.ps1 -Mode local
```

- **[日志参考]**
  - 首次无 DB：`database not found at ...; initializing schema (auto-migrate forced)`
  - 存在 DB 且跳过：`existing database found; skipping migrations (MSS_AUTO_MIGRATE=0)...`
  - 待迁移列表：`migrate: pending versions: 0002,...`
  - 执行迁移：`existing database found; MSS_AUTO_MIGRATE=1 -> applying migrations`
